<section>
    <div class="container">
        <figure>
            <img class="detailPhoto" src="<%= coupon.image %>" />
        </figure>


    </div>
</section>



<section>
    <div class="container">
        <ul class="a">
            <li><%= coupon.restaurant %></li>
            <li><%= coupon.title %></li>
            <li>Coins: <%= coupon.coin %></li>
            <li>Address: <%= coupon.mall %>,<%= coupon.region %></li>
            <li>Expiry Date: <%= coupon.expireDate %></li>
            <li><%= coupon.detail %></li>
        </ul>
    </div>

    <% if(user.userid){ %>
    
    <div class="field">
        <div class="control">
            <button class="button is-link " id = "redeem" type="submit" onclick="redeem('<%= coupon.id %>', '<%= user.userid %>', '<%= coupon.coin %>', '<%= user.coin %>', '<%= coupon.quota %>' )">Redeem</button>
        </div>
    </div>
  <% } %>
</section>


<!--<script>
    if(user.role = "admin" || "member"){
        Redeem.button
    }

</script>-->


<script>
    async function redeem(couponid, userid, couponcoin, usercoin, couponquota) {
        

        var r = confirm("Confirm Redeem?");
        
        if (r) {
            if(usercoin >= couponcoin && couponquota > 0){

            var response = await fetch("/user/"+ userid + "/have/add/" + couponid, {
                method: "POST"
            });

            if (response.ok) {

                var x = document.getElementById("redeem");
                x.style.display = "none";

                usercoin = usercoin - couponcoin;
                couponqouta = couponquota - 1;

                var response = await fetch("/coupon/"+ couponid, {
                method: "PUT"
            });
                alert("The coupon has been redeemed.");
            } else {
                alert(response.status + ": " + response.statusText);
            }
        }

        } else {
            alert("cancelled");
        }
    };
</script>
